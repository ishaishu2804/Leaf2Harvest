{% extends "base.html" %}

{% block title %}Diagnosis Result{% endblock %}

{% block extra_css %}
<style>
    .result-hero {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 40px 0;
        margin-bottom: 40px;
    }
    
    .result-card {
        border: none;
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .result-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }
    
    .result-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 30px;
        text-align: center;
    }
    
    .disease-badge {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        padding: 15px 30px;
        border-radius: 50px;
        font-size: 1.2rem;
        font-weight: 600;
        display: inline-block;
        margin: 20px 0;
        box-shadow: 0 8px 20px rgba(220, 53, 69, 0.3);
    }
    
    .confidence-meter {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
    }
    
    .confidence-bar {
        height: 20px;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border-radius: 10px;
        position: relative;
        overflow: hidden;
    }
    
    .confidence-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
    }
    
    .treatment-card {
        background: linear-gradient(135deg, #e8f5e9 0%, #d4edda 100%);
        border: none;
        border-radius: 15px;
        padding: 25px;
        margin: 20px 0;
    }
    
    .treatment-card .card-header {
        background: transparent;
        border: none;
        padding: 0 0 15px 0;
    }
    
    .treatment-card .card-title {
        color: #155724;
        font-weight: 600;
        margin: 0;
    }
    
    .image-container {
        text-align: center;
        margin: 30px 0;
    }
    
    .result-image {
        max-width: 100%;
        max-height: 400px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }
    
    .result-image:hover {
        transform: scale(1.02);
    }
    
    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
        flex-wrap: wrap;
    }
    
    .btn-primary-custom {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        border: none;
        padding: 12px 25px;
        border-radius: 25px;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    }
    
    .btn-primary-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 123, 255, 0.4);
        color: white;
    }
    
    .btn-success-custom {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        padding: 12px 25px;
        border-radius: 25px;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }
    
    .btn-success-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        color: white;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 30px 0;
    }
    
    .info-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        text-align: center;
        transition: transform 0.3s ease;
    }
    
    .info-card:hover {
        transform: translateY(-3px);
    }
    
    .info-icon {
        font-size: 2.5rem;
        margin-bottom: 15px;
    }
    
    .severity-indicator {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        margin: 10px 0;
    }
    
    .severity-high {
        background: #f8d7da;
        color: #721c24;
    }
    
    .severity-medium {
        background: #fff3cd;
        color: #856404;
    }
    
    .severity-low {
        background: #d1ecf1;
        color: #0c5460;
    }
    
    .recommendations-list {
        list-style: none;
        padding: 0;
    }
    
    .recommendations-list li {
        padding: 10px 0;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        align-items: center;
    }
    
    .recommendations-list li:last-child {
        border-bottom: none;
    }
    
    .recommendations-list li i {
        color: #28a745;
        margin-right: 10px;
        width: 20px;
    }
    
    .treatment-section {
        margin-bottom: 25px;
        padding: 20px;
        background: white;
        border-radius: 10px;
        border-left: 4px solid #28a745;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .treatment-subtitle {
        color: #155724;
        font-weight: 600;
        margin-bottom: 12px;
        font-size: 1rem;
        display: flex;
        align-items: center;
    }
    
    .treatment-text {
        color: #495057;
        margin-bottom: 0;
        line-height: 1.6;
    }
    
    .treatment-steps {
        margin-top: 10px;
    }
    
    .treatment-step {
        display: flex;
        align-items: flex-start;
        margin-bottom: 8px;
        padding: 8px 0;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .treatment-step:last-child {
        border-bottom: none;
    }
    
    .treatment-step i {
        margin-top: 2px;
        flex-shrink: 0;
    }
    
    .treatment-step span {
        color: #495057;
        line-height: 1.5;
    }
    
    .treatment-resources {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .resource-item {
        display: flex;
        align-items: center;
        padding: 8px 0;
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .treatment-structured {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
    }
    
    .treatment-fallback {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
    }
    
    .confidence-guide {
        text-align: center;
        padding: 15px;
        background: white;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .confidence-guide .badge {
        font-size: 0.9rem;
        padding: 8px 12px;
        margin-bottom: 8px;
    }
    
    @media (max-width: 768px) {
        .action-buttons {
            flex-direction: column;
            align-items: center;
        }
        
        .action-buttons .btn {
            width: 100%;
            max-width: 300px;
        }
        
        .info-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="result-hero">
    <div class="container text-center">
        <h1 class="display-5 fw-bold mb-3">
            <i class="fas fa-clipboard-check me-3"></i>Diagnosis Complete
        </h1>
        <p class="lead mb-0">Your plant analysis results are ready</p>
    </div>
</div>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="result-card">
                <div class="result-header">
                    <h2 class="mb-3">
                        <i class="fas fa-microscope me-2"></i>Analysis Results
                    </h2>
                    <p class="mb-0">AI-powered disease detection completed successfully</p>
                </div>
                
                <div class="card-body p-5">
                    <!-- Diagnosis Method Badge -->
                    {% if diagnosis_method %}
                    <div class="text-center mb-4">
                        {% if diagnosis_method == 'openai' %}
                            <span class="badge bg-success fs-6 px-3 py-2">
                                <i class="fas fa-brain me-2"></i>AI-Powered Analysis
                            </span>
                        {% elif diagnosis_method == 'local_model' %}
                            <span class="badge bg-info fs-6 px-3 py-2">
                                <i class="fas fa-microchip me-2"></i>Local Model Analysis
                            </span>
                        {% else %}
                            <span class="badge bg-warning fs-6 px-3 py-2">
                                <i class="fas fa-leaf me-2"></i>Expert Recommendations
                            </span>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Image Display -->
                    <div class="image-container">
                        <img src="{{ url_for('static', filename='uploads/' ~ image_path) }}" 
                             alt="Analyzed Plant Image" 
                             class="result-image">
                        <p class="text-muted mt-3">
                            <i class="fas fa-image me-1"></i>Analyzed plant image
                        </p>
                    </div>
                    
                    <!-- Disease Detection Result -->
                    <div class="text-center mb-4">
                        <h3 class="mb-3">Detected Condition</h3>
                        <div class="disease-badge">
                            <i class="fas fa-exclamation-triangle me-2"></i>{{ disease }}
                        </div>
                    </div>
                    
                    <!-- Confidence Score -->
                    {% if confidence %}
                    <div class="confidence-meter">
                        <h5 class="mb-3">
                            <i class="fas fa-chart-line me-2"></i>Confidence Level
                        </h5>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-semibold">Analysis Confidence</span>
                            <span class="fw-bold text-success">{{ confidence }}%</span>
                        </div>
                        <div class="confidence-bar" style="width: {{ confidence }}%"></div>
                        <div class="mt-2 text-center">
                            <small class="text-muted">
                                {% if confidence >= 80 %}
                                    <i class="fas fa-check-circle text-success me-1"></i>High confidence diagnosis
                                {% elif confidence >= 60 %}
                                    <i class="fas fa-exclamation-circle text-warning me-1"></i>Moderate confidence diagnosis
                                {% else %}
                                    <i class="fas fa-question-circle text-info me-1"></i>Low confidence - consider expert consultation
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Additional Information Grid -->
                    <div class="info-grid">
                        <div class="info-card">
                            <i class="fas fa-calendar-alt info-icon text-primary"></i>
                            <h6 class="fw-semibold">Analysis Date</h6>
                            <p class="text-muted mb-0">Today</p>
                        </div>
                        <div class="info-card">
                            <i class="fas fa-clock info-icon text-info"></i>
                            <h6 class="fw-semibold">Processing Time</h6>
                            <p class="text-muted mb-0">~2-3 seconds</p>
                        </div>
                        <div class="info-card">
                            <i class="fas fa-robot info-icon text-success"></i>
                            <h6 class="fw-semibold">AI Model</h6>
                            <p class="text-muted mb-0">GPT-4 Vision</p>
                        </div>
                    </div>
                    
                    <!-- Treatment Recommendations -->
                    <div class="treatment-card">
                        <div class="card-header">
                            <h4 class="card-title">
                                <i class="fas fa-prescription-bottle-alt me-2"></i>Treatment & Care Recommendations
                            </h4>
                        </div>
                        <div class="card-body">
                            {% if treatment %}
                                <div class="treatment-content">
                                    {% if '**Disease:**' in treatment %}
                                        <!-- Structured OpenAI response -->
                                        <div class="treatment-structured">
                                            {% for line in treatment.split('\n') %}
                                                {% if line.strip() %}
                                                    {% if line.startswith('**Disease:**') %}
                                                        <div class="treatment-section">
                                                            <h6 class="treatment-subtitle">
                                                                <i class="fas fa-bug text-danger me-2"></i>Disease Identified
                                                            </h6>
                                                            <p class="treatment-text">{{ line.replace('**Disease:**', '').strip() }}</p>
                                                        </div>
                                                    {% elif line.startswith('**Severity:**') %}
                                                        <div class="treatment-section">
                                                            <h6 class="treatment-subtitle">
                                                                <i class="fas fa-exclamation-triangle text-warning me-2"></i>Severity Level
                                                            </h6>
                                                            <p class="treatment-text">{{ line.replace('**Severity:**', '').strip() }}</p>
                                                        </div>
                                                    {% elif line.startswith('**Symptoms:**') %}
                                                        <div class="treatment-section">
                                                            <h6 class="treatment-subtitle">
                                                                <i class="fas fa-search text-info me-2"></i>Visible Symptoms
                                                            </h6>
                                                            <p class="treatment-text">{{ line.replace('**Symptoms:**', '').strip() }}</p>
                                                        </div>
                                                    {% elif line.startswith('**Treatment Recommendations:**') %}
                                                        <div class="treatment-section">
                                                            <h6 class="treatment-subtitle">
                                                                <i class="fas fa-tools text-success me-2"></i>Treatment Plan
                                                            </h6>
                                                            <div class="treatment-steps">
                                                                {% for step in line.replace('**Treatment Recommendations:**', '').strip().split('.') %}
                                                                    {% if step.strip() %}
                                                                    <div class="treatment-step">
                                                                        <i class="fas fa-check-circle text-success me-2"></i>
                                                                        <span>{{ step.strip() }}</span>
                                                                    </div>
                                                                    {% endif %}
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                    {% elif line.startswith('**Prevention Measures:**') %}
                                                        <div class="treatment-section">
                                                            <h6 class="treatment-subtitle">
                                                                <i class="fas fa-shield-alt text-primary me-2"></i>Prevention Strategy
                                                            </h6>
                                                            <div class="treatment-steps">
                                                                {% for step in line.replace('**Prevention Measures:**', '').strip().split('.') %}
                                                                    {% if step.strip() %}
                                                                    <div class="treatment-step">
                                                                        <i class="fas fa-lightbulb text-warning me-2"></i>
                                                                        <span>{{ step.strip() }}</span>
                                                                    </div>
                                                                    {% endif %}
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <!-- Fallback treatment display -->
                                        <div class="treatment-fallback">
                                            {% for line in treatment.split('\n') %}
                                                {% if line.strip() %}
                                                    {% if line.startswith('**') and line.endswith(':**') %}
                                                        <h6 class="treatment-subtitle">
                                                            <i class="fas fa-star text-success me-2"></i>{{ line.replace('**', '').replace(':**', '') }}
                                                        </h6>
                                                    {% elif line.startswith('- ') %}
                                                        <div class="treatment-step">
                                                            <i class="fas fa-arrow-right text-success me-2"></i>
                                                            <span>{{ line.replace('- ', '') }}</span>
                                                        </div>
                                                    {% elif line.startswith('• ') %}
                                                        <div class="treatment-step">
                                                            <i class="fas fa-check-circle text-success me-2"></i>
                                                            <span>{{ line.replace('• ', '') }}</span>
                                                        </div>
                                                    {% elif line.startswith('1. **') or line.startswith('2. **') or line.startswith('3. **') or line.startswith('4. **') or line.startswith('5. **') or line.startswith('6. **') or line.startswith('7. **') or line.startswith('8. **') or line.startswith('9. **') %}
                                                        <div class="treatment-step">
                                                            <i class="fas fa-check-circle text-success me-2"></i>
                                                            <span>{{ line.replace('**', '').replace('**:', ':') }}</span>
                                                        </div>
                                                    {% elif line.startswith('1. ') or line.startswith('2. ') or line.startswith('3. ') or line.startswith('4. ') or line.startswith('5. ') or line.startswith('6. ') or line.startswith('7. ') or line.startswith('8. ') or line.startswith('9. ') %}
                                                        <div class="treatment-step">
                                                            <i class="fas fa-check-circle text-success me-2"></i>
                                                            <span>{{ line }}</span>
                                                        </div>
                                                    {% elif line.strip() and not line.startswith('**') and not line.startswith('General Care:') and not line.startswith('Common Issues to Watch For:') and not line.startswith('Prevention:') %}
                                                        <p class="treatment-text">{{ line.strip() }}</p>
                                                    {% elif line.strip() and (line.startswith('General Care:') or line.startswith('Common Issues to Watch For:') or line.startswith('Prevention:')) %}
                                                        <h6 class="treatment-subtitle">
                                                            <i class="fas fa-list text-primary me-2"></i>{{ line.strip() }}
                                                        </h6>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Additional Resources -->
                                <div class="treatment-resources mt-4">
                                    <h6 class="treatment-subtitle">
                                        <i class="fas fa-book text-info me-2"></i>Additional Resources
                                    </h6>
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <div class="resource-item">
                                                <i class="fas fa-calendar-check text-primary me-2"></i>
                                                <span>Monitor progress weekly</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="resource-item">
                                                <i class="fas fa-user-md text-success me-2"></i>
                                                <span>Consult expert if symptoms worsen</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="resource-item">
                                                <i class="fas fa-camera text-info me-2"></i>
                                                <span>Take follow-up photos for comparison</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="resource-item">
                                                <i class="fas fa-chart-line text-warning me-2"></i>
                                                <span>Track treatment effectiveness</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="alert alert-warning" role="alert">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Expert Consultation Recommended:</strong><br>
                                    For specific treatment recommendations, please consult with a plant pathologist or agricultural expert.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Severity Assessment -->
                    <div class="text-center mb-4">
                        <h5 class="mb-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>Severity Assessment
                        </h5>
                        {% set severity = 'medium' %}
                        {% if 'severe' in disease.lower() or 'critical' in disease.lower() %}
                            {% set severity = 'high' %}
                        {% elif 'mild' in disease.lower() or 'early' in disease.lower() %}
                            {% set severity = 'low' %}
                        {% endif %}
                        
                        <div class="severity-indicator severity-{{ severity }}">
                            {% if severity == 'high' %}
                                <i class="fas fa-exclamation-triangle me-2"></i>High Severity - Immediate Action Required
                            {% elif severity == 'medium' %}
                                <i class="fas fa-exclamation-circle me-2"></i>Moderate Severity - Monitor Closely
                            {% else %}
                                <i class="fas fa-info-circle me-2"></i>Low Severity - Preventive Measures Recommended
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <a href="{{ url_for('openai_diagnosis') }}" class="btn btn-success-custom">
                            <i class="fas fa-plus me-2"></i>Analyze Another Image
                        </a>
                        <a href="{{ url_for('diagnosis_history') }}" class="btn btn-primary-custom">
                            <i class="fas fa-history me-2"></i>View History
                        </a>
                        <button onclick="window.print()" class="btn btn-outline-secondary">
                            <i class="fas fa-print me-2"></i>Print Report
                        </button>
                    </div>
                    
                    <!-- Confidence Improvement Tips -->
                    <div class="mt-5">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-chart-line me-2"></i>How to Improve Diagnosis Accuracy
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-info mb-3">
                                            <i class="fas fa-camera me-2"></i>Image Quality Tips
                                        </h6>
                                        <ul class="list-unstyled">
                                            <li class="mb-2">
                                                <i class="fas fa-check text-success me-2"></i>
                                                <strong>Good Lighting:</strong> Use natural light or bright artificial light
                                            </li>
                                            <li class="mb-2">
                                                <i class="fas fa-check text-success me-2"></i>
                                                <strong>Clear Focus:</strong> Ensure the affected area is sharp and in focus
                                            </li>
                                            <li class="mb-2">
                                                <i class="fas fa-check text-success me-2"></i>
                                                <strong>Close-up View:</strong> Fill the frame with the affected plant part
                                            </li>
                                            <li class="mb-2">
                                                <i class="fas fa-check text-success me-2"></i>
                                                <strong>Multiple Angles:</strong> Take photos from different perspectives
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-info mb-3">
                                            <i class="fas fa-seedling me-2"></i>Information Accuracy
                                        </h6>
                                        <ul class="list-unstyled">
                                            <li class="mb-2">
                                                <i class="fas fa-check text-success me-2"></i>
                                                <strong>Correct Crop Type:</strong> Always select the accurate crop type
                                            </li>
                                            <li class="mb-2">
                                                <i class="fas fa-check text-success me-2"></i>
                                                <strong>Growth Stage:</strong> Note if plant is young, mature, or flowering
                                            </li>
                                            <li class="mb-2">
                                                <i class="fas fa-check text-success me-2"></i>
                                                <strong>Environmental Conditions:</strong> Consider recent weather patterns
                                            </li>
                                            <li class="mb-2">
                                                <i class="fas fa-check text-success me-2"></i>
                                                <strong>Multiple Samples:</strong> Analyze different affected areas
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="alert alert-light mt-3">
                                    <h6 class="alert-heading">
                                        <i class="fas fa-lightbulb text-warning me-2"></i>Confidence Level Guide
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="confidence-guide">
                                                <span class="badge bg-success">90-100%</span>
                                                <small class="d-block text-muted">Excellent image quality, clear symptoms, accurate crop type</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="confidence-guide">
                                                <span class="badge bg-warning">70-89%</span>
                                                <small class="d-block text-muted">Good quality, some uncertainty, follow recommendations</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="confidence-guide">
                                                <span class="badge bg-danger">Below 70%</span>
                                                <small class="d-block text-muted">Poor quality, consult expert, retake photos</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}